#!/anaconda3/bin/python3

# Python Standard Library
import argparse
from os import path, listdir

# Other dependencies
from obspy import UTCDateTime, Stream, read
import pandas as pd

from st_to_lakiy import st_to_lakiy


parser = argparse.ArgumentParser()
parser.add_argument('filepath', help='Path to segments csv file')
parser.add_argument('inpath', help='Path folder with mseed files')
parser.add_argument('outpath', help='Path folder with mseed files')
parser.add_argument('--window_length', default=3.99, help='Window length [s]')
args = parser.parse_args()

df = pd.read_csv(args.filepath)

st = Stream()
for filename in listdir(args.inpath):
    try:
        st += read(path.join(args.inpath, filename))
    except:
        continue

for i, row in df.iterrows():
    print(i, row.label)

    starttime = UTCDateTime(row.starttime)
    endtime   = UTCDateTime(row.endtime)

    if endtime - starttime < args.window_length:
        endtime = starttime + args.window_length

    _st = st.slice(starttime, endtime)

    st_to_lakiy(_st, starttime, endtime, args.window_length, args.outpath,
                row.label)

